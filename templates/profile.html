<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Quote Generator</title>
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='images/favicon.jpg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            background: #1a1a2e;
            min-height: 100vh;
            padding: 20px;
        }
        .profile-nav {
            background: #2c3e50;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .profile-nav .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .profile-nav .nav-left h1 {
            color: #fff;
            font-size: 20px;
            margin: 0;
        }
        .profile-nav a {
            color: #aaa;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .profile-nav a:hover {
            background: #1a5f5a;
            color: #fff;
        }
        .profile-nav .user-email {
            color: #888;
            font-size: 14px;
        }
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .profile-section {
            background: #2c3e50;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .profile-section h2 {
            color: #fff;
            margin: 0 0 20px 0;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: #aaa;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #1a1a2e;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1a5f5a;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .save-btn {
            background: #1a5f5a;
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .save-btn:hover {
            background: #2a7a73;
        }
        .save-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .success-message {
            background: #27ae60;
            color: #fff;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        .error-message {
            background: #e74c3c;
            color: #fff;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        .setup-banner {
            background: linear-gradient(135deg, #1a5f5a 0%, #2a7a73 100%);
            color: #fff;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .setup-banner h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            border: none;
            padding: 0;
        }
        .setup-banner p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .setup-banner .required-note {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.15);
            border-radius: 5px;
            font-size: 13px;
        }
        .required-field label::after {
            content: ' *';
            color: #e74c3c;
        }
        .password-section {
            border-top: 1px solid #444;
            padding-top: 20px;
            margin-top: 20px;
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        .profile-pic-section {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #444;
        }
        .profile-pic-preview {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            background: #1a1a2e;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid #444;
        }
        .profile-pic-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-pic-preview .placeholder {
            color: #555;
            font-size: 40px;
        }
        .profile-pic-upload {
            flex: 1;
        }
        .profile-pic-upload h3 {
            color: #fff;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .profile-pic-upload p {
            color: #888;
            margin: 0 0 15px 0;
            font-size: 13px;
        }
        .upload-btn {
            background: #1a5f5a;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .upload-btn:hover {
            background: #2a7a73;
        }
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="profile-nav">
        <div class="nav-left">
            <h1>Profile Settings</h1>
            <a href="/">Quotes</a>
            <a href="/history">History</a>
            {% if current_user.role == 'admin' %}
            <a href="/admin">Admin</a>
            {% endif %}
        </div>
        <div>
            <span class="user-email">{{ current_user.username }}</span>
            <a href="/logout">Logout</a>
        </div>
    </nav>

    <div class="profile-container">
        <!-- First-time Setup Banner -->
        <div id="setupBanner" class="setup-banner">
            <h2>Welcome! Let's set up your profile</h2>
            <p>Please fill in your business information below. This will appear on your invoices and quotes.</p>
            <div class="required-note">
                <strong>Required fields:</strong> Business Name, Full Name, Address, and Phone Number
            </div>
        </div>

        <div id="successMessage" class="success-message">Profile saved successfully!</div>
        <div id="errorMessage" class="error-message"></div>

        <!-- Profile Picture -->
        <div class="profile-section">
            <h2>Profile Picture</h2>
            <div class="profile-pic-section">
                <div class="profile-pic-preview" id="profilePicPreview">
                    <span class="placeholder">ðŸ“·</span>
                </div>
                <div class="profile-pic-upload">
                    <h3>Upload Logo/Profile Picture</h3>
                    <p>This image will appear on your invoices. Recommended: Square image, at least 200x200px. Max 5MB.</p>
                    <input type="file" id="profilePicInput" class="file-input" accept="image/png,image/jpeg,image/gif">
                    <button class="upload-btn" onclick="document.getElementById('profilePicInput').click()">Choose Image</button>
                    <span id="uploadStatus" style="margin-left: 15px; color: #888; font-size: 13px;"></span>
                </div>
            </div>
        </div>

        <!-- Business Information -->
        <div class="profile-section">
            <h2>Business Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="business_name">Business Name (for invoice header)</label>
                    <input type="text" id="business_name" placeholder="e.g., JOHN DOE PRODUCTIONS">
                </div>
                <div class="form-group">
                    <label for="full_name">Full Name</label>
                    <input type="text" id="full_name" placeholder="e.g., John Doe">
                </div>
            </div>
            <div class="form-group">
                <label for="address">Address</label>
                <textarea id="address" placeholder="e.g., 123 Business Street, Dubai, UAE"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" placeholder="+971 50 000 0000">
                </div>
                <div class="form-group">
                    <label for="email_display">Email (for invoices)</label>
                    <input type="email" id="email_display" placeholder="email@example.com">
                </div>
            </div>
        </div>

        <!-- Bank Details -->
        <div class="profile-section">
            <h2>Bank Details (Defaults for new quotes)</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="bank_account_holder">Account Holder Name</label>
                    <input type="text" id="bank_account_holder" placeholder="Name on bank account">
                </div>
                <div class="form-group">
                    <label for="bank_name">Bank Name</label>
                    <input type="text" id="bank_name" placeholder="e.g., Emirates NBD">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bank_account_number">Account Number</label>
                    <input type="text" id="bank_account_number" placeholder="Account number">
                </div>
                <div class="form-group">
                    <label for="bank_iban">IBAN</label>
                    <input type="text" id="bank_iban" placeholder="e.g., AE12 0000 0000 0000 0000 000">
                </div>
            </div>
        </div>

        <!-- Default Settings -->
        <div class="profile-section">
            <h2>Default Quote Settings</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="default_hourly_rate">Default Hourly Rate (AED)</label>
                    <input type="number" id="default_hourly_rate" min="0" step="10" placeholder="200">
                </div>
                <div class="form-group">
                    <label for="default_job_description">Default Job Description</label>
                    <input type="text" id="default_job_description" placeholder="e.g., Sound Operator">
                </div>
            </div>
            <button class="save-btn" onclick="saveProfile()">Save Profile</button>
        </div>

        <!-- Change Password -->
        <div class="profile-section">
            <h2>Change Password</h2>
            <div id="passwordSuccess" class="success-message">Password changed successfully!</div>
            <div id="passwordError" class="error-message"></div>
            <div class="form-row">
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password">
                </div>
                <div class="form-group">
                    <label for="new_password">New Password (min 8 characters)</label>
                    <input type="password" id="new_password">
                </div>
            </div>
            <button class="save-btn" onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <script>
        let profile = null;

        async function loadProfile() {
            try {
                const response = await fetch('/api/profile');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                profile = await response.json();

                // Populate fields
                document.getElementById('business_name').value = profile.business_name || '';
                document.getElementById('full_name').value = profile.full_name || '';
                document.getElementById('address').value = profile.address || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('email_display').value = profile.email || '';
                document.getElementById('bank_account_holder').value = profile.bank_account_holder || '';
                document.getElementById('bank_name').value = profile.bank_name || '';
                document.getElementById('bank_account_number').value = profile.bank_account_number || '';
                document.getElementById('bank_iban').value = profile.bank_iban || '';
                document.getElementById('default_hourly_rate').value = profile.default_hourly_rate || 200;
                document.getElementById('default_job_description').value = profile.default_job_description || 'Sound Operator';

                // Load profile picture
                updateProfilePicPreview(profile.profilepic);
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function updateProfilePicPreview(url) {
            const preview = document.getElementById('profilePicPreview');
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Profile Picture">`;
            } else {
                preview.innerHTML = '<span class="placeholder">ðŸ“·</span>';
            }
        }

        async function uploadProfilePic(file) {
            const status = document.getElementById('uploadStatus');
            status.textContent = 'Uploading...';
            status.style.color = '#888';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/profile/picture', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    updateProfilePicPreview(data.profilepic);
                    status.textContent = 'Uploaded successfully!';
                    status.style.color = '#27ae60';
                    setTimeout(() => { status.textContent = ''; }, 3000);
                } else {
                    status.textContent = data.error || 'Upload failed';
                    status.style.color = '#e74c3c';
                }
            } catch (error) {
                status.textContent = 'Upload failed';
                status.style.color = '#e74c3c';
            }
        }

        // Handle file selection
        document.getElementById('profilePicInput').addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                uploadProfilePic(e.target.files[0]);
            }
        });

        async function saveProfile() {
            const data = {
                business_name: document.getElementById('business_name').value,
                full_name: document.getElementById('full_name').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email_display').value,
                bank_account_holder: document.getElementById('bank_account_holder').value,
                bank_name: document.getElementById('bank_name').value,
                bank_account_number: document.getElementById('bank_account_number').value,
                bank_iban: document.getElementById('bank_iban').value,
                default_hourly_rate: parseFloat(document.getElementById('default_hourly_rate').value) || 200,
                default_job_description: document.getElementById('default_job_description').value || 'Sound Operator'
            };

            // Check required fields in setup mode
            const urlParams = new URLSearchParams(window.location.search);
            const isSetupMode = urlParams.get('setup') === '1';
            if (isSetupMode) {
                const requiredFields = ['business_name', 'full_name', 'address', 'phone'];
                const missingFields = requiredFields.filter(f => !data[f] || !data[f].trim());
                if (missingFields.length > 0) {
                    document.getElementById('errorMessage').textContent = 'Please fill in all required fields: Business Name, Full Name, Address, and Phone';
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }
            }

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'none';

                    // Redirect to home after saving in setup mode
                    if (isSetupMode) {
                        document.getElementById('successMessage').textContent = 'Profile saved! Redirecting to Quote Generator...';
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        setTimeout(() => {
                            document.getElementById('successMessage').style.display = 'none';
                        }, 3000);
                    }
                } else {
                    const error = await response.json();
                    document.getElementById('errorMessage').textContent = error.error || 'Error saving profile';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Error saving profile';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;

            if (!currentPassword || !newPassword) {
                document.getElementById('passwordError').textContent = 'Please fill in both password fields';
                document.getElementById('passwordError').style.display = 'block';
                return;
            }

            if (newPassword.length < 8) {
                document.getElementById('passwordError').textContent = 'New password must be at least 8 characters';
                document.getElementById('passwordError').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/profile/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                if (response.ok) {
                    document.getElementById('passwordSuccess').style.display = 'block';
                    document.getElementById('passwordError').style.display = 'none';
                    document.getElementById('current_password').value = '';
                    document.getElementById('new_password').value = '';
                    setTimeout(() => {
                        document.getElementById('passwordSuccess').style.display = 'none';
                    }, 3000);
                } else {
                    const error = await response.json();
                    document.getElementById('passwordError').textContent = error.error || 'Error changing password';
                    document.getElementById('passwordError').style.display = 'block';
                    document.getElementById('passwordSuccess').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('passwordError').textContent = 'Error changing password';
                document.getElementById('passwordError').style.display = 'block';
            }
        }

        // Check if this is first-time setup
        function checkSetupMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('setup') === '1') {
                document.getElementById('setupBanner').style.display = 'block';
                // Add required-field class to required inputs
                ['business_name', 'full_name', 'address', 'phone'].forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.parentElement.classList.add('required-field');
                    }
                });
            }
        }

        // Load profile on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            checkSetupMode();
        });
    </script>
</body>
</html>
